<!doctype html>
<html lang="fr">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>TP4 - Exercice 1 : SceneVR</title>
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/c-frame/aframe-extras@7.5.0/dist/aframe-extras.min.js"></script>
    <style>body { margin: 0; }</style>
</head>
<body>
<a-scene shadow="type: pcfsoft">

    <!-- Assets -->
    <a-assets></a-assets>

    <!-- Lights -->
    <a-entity id="sun" light="type: directional; intensity: 1; castShadow: true; shadowBias: -0.0001; shadowCameraVisible: false" position="-2 4 4" rotation="-45 30 0"></a-entity>

    <!-- Ambient light -->
    <a-entity light="type: ambient; intensity: 0.5"></a-entity>

    <a-plane rotation="-90 0 0" width="30" height="30" color="#7BC8A4" shadow="receive: true" position="0 0 0"></a-plane>

    <!-- objects -->
    <a-box id="cube" position="-1 0.75 -3" rotation="0 45 0" depth="1" height="1" width="1" color="#4CC3D9" shadow="cast: true; receive: true"></a-box>
    <a-sphere id="sphere" position="1 1.2 -2" radius="0.7" color="#EF2D5E" shadow="cast: true; receive: true"></a-sphere>
    <a-cylinder position="3 0.7 -4" radius="0.5" height="1.4" color="#FFC65D" shadow="cast: true; receive: true"></a-cylinder>

    <!-- Camera rig with movement-controls and custom joystick rotation handling -->
    <a-entity id="rig" movement-controls="speed: 0.15; fly: false">
        <!-- Camera -->
        <a-entity id="camera" camera look-controls="pointerLockEnabled: true" position="0 1.6 0"></a-entity>

        <!-- Left controller: hand model + pointer ray -->
        <a-entity id="leftHand"
                  hand-controls="hand: left; handModelStyle: lowPoly; color: #ffcccc"
                  raycaster="objects: .interactable"
                  line="opacity: 0.9"
                  position="0 1.5 0"></a-entity>

        <!-- Right controller: hand model -->
        <a-entity id="rightHand"
                  hand-controls="hand: right; handModelStyle: highPoly; color: #ffcccc"
                  position="0 1.5 0"></a-entity>
    </a-entity>

    <!-- Sky -->
    <a-sky color="#c4f6ff"></a-sky>

    <!-- Script: map right gamepad stick to rig rotation (yaw) -->
    <script>
        AFRAME.registerComponent('gamepad-rotate', {
            init: function () {
                this.gamepadIndex = null;
            },
            tick: function () {
                // Find the first connected gamepad with axes
                const gamepads = navigator.getGamepads ? navigator.getGamepads() : [];
                let gp = null;
                for (let i = 0; i < gamepads.length; i++) {
                    const g = gamepads[i];
                    if (g && g.connected && g.axes && g.axes.length >= 4) { gp = g; break; }
                }
                if (!gp) return;
                // Right stick is usually axes 2 (x) and 3 (y). We'll use x for yaw rotation.
                const rx = gp.axes[2] || 0;
                // Deadzone
                const dead = 0.2;
                const strength = Math.abs(rx) > dead ? rx : 0;
                if (strength !== 0) {
                    const rig = document.querySelector('#rig');
                    // rotate around Y (degrees)
                    const turnSpeed = 1.8; // degrees per frame multiplier
                    const currentRot = rig.getAttribute('rotation');
                    const newY = currentRot.y - strength * turnSpeed;
                    rig.setAttribute('rotation', { x: currentRot.x, y: newY, z: currentRot.z });
                }
            }
        });

        // Attach the component to the scene so it runs
        document.addEventListener('DOMContentLoaded', function () {
            const scene = document.querySelector('a-scene');
            if (scene) scene.setAttribute('gamepad-rotate', '');
        });
    </script>

</a-scene>
</body>
</html>
