<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>TP04 - WebVR</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <script src="https://aframe.io/releases/1.7.0/aframe.min.js"></script>
    <script> delete AFRAME.components["grabbable"]; </script> <!-- cf. super-hands -->
    <script src="https://cdn.jsdelivr.net/gh/c-frame/aframe-extras@7.5.2/dist/aframe-extras.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@c-frame/aframe-physics-system@4.1.0/dist/aframe-physics-system.min.js"></script>
    <script src="https://unpkg.com/super-hands@3.0.5/dist/super-hands.min.js"></script>
</head>

<body>
<a-scene
        shadow="type: pcfsoft"
        renderer="antialias: true"
        vr-mode-ui="enabled: true"
        device-orientation-permission-ui="enabled: true"
        physics="gravity: -9.8; debug: false"
>
    <!-- Assets -->
    <a-assets>
        <a-asset-item id="gun" src="./pistol.glb"></a-asset-item>
        <a-asset-item id="projectile" src="./projectile.glb"></a-asset-item>
    </a-assets>

    <!-- Lumières -->
    <a-entity light="type: ambient; intensity: 0.8"></a-entity>
    <a-entity light="type: directional; intensity: 5; castShadow: true" position="2 4 -2"></a-entity>

    <!-- RIG + caméra + contrôleurs -->
    <a-entity id="rig" position="0.77334 0.16159 4.0298" joystick-movement="speed: 2" snap-turn="angle: 30; cooldown: 300">
        <a-entity id="head" camera wasd-controls-enabled="false" look-controls></a-entity>

        <!-- Mains : super-hands limité au bouton grip (side) + collision par sphère -->
        <a-entity id="leftHand"
                  oculus-touch-controls="hand: left"
                  super-hands="grabStartButtons: gripdown, squeezestart; grabEndButtons: gripup, squeezeend"
                  sphere-collider="objects: .grabbable"
                  static-body="shape: sphere; sphereRadius: 0.03">
        </a-entity>

        <a-entity id="rightHand"
                  oculus-touch-controls="hand: right"
                  super-hands="grabStartButtons: gripdown, squeezestart; grabEndButtons: gripup, squeezeend"
                  sphere-collider="objects: .grabbable"
                  static-body="shape: sphere; sphereRadius: 0.03">
        </a-entity>
    </a-entity>

    <!-- OBJETS SAISISSABLES (physiques) -->
    <a-box id="box" class="grabbable" position="0.39839 1.34898 -4.73534" rotation="0 45 0" color="#4CC3D9"
           shadow="cast: true; receive: true"
           grabbable="usePhysics: only; startButtons: gripdown, squeezestart; endButtons: gripup, squeezeend"
           dynamic-body="mass: 1; shape: box">
    </a-box>

    <a-sphere id="sphere" class="grabbable" position="-2.22715 1.32169 -1.28134" radius="0.5" color="#EF2D5E"
              shadow="cast: true; receive: true"
              grabbable="usePhysics: only; startButtons: gripdown, squeezestart; endButtons: gripup, squeezeend"
              dynamic-body="mass: 0.5; shape: sphere">
    </a-sphere>

    <a-cylinder id="cylinder" class="grabbable" position="3.74305 1.58472 -2.06682" radius="0.4" height="1" color="#FFC65D"
                shadow="cast: true; receive: true"
                grabbable="usePhysics: only; startButtons: gripdown, squeezestart; endButtons: gripup, squeezeend"
                dynamic-body="mass: 0.75; shape: cylinder">
    </a-cylinder>

    <a-entity id="GunWrapper" rotation="0 0 0" scale="1 1 1"
              position="0 1 0"
              class="grabbable"
              shadow="cast: true; receive: true"
              geometry="primitive: box; width: 0.3; height: 0.15; depth: 0.05"
              material="opacity: 0; transparent: true"
              visible="true"
              grabbable="usePhysics: only; startButtons: gripdown, squeezestart; endButtons: gripup, squeezeend"
              dynamic-body="mass: 1; shape: box"
              gun-shoot="hand: #rightHand;">

        <a-entity id="gunModel" position="0 0 0"
                  gltf-model="#gun"
                  scale="0.05 0.05 0.05"
                  shadow="cast: true; receive: true">
        </a-entity>

        <a-entity id="shootPos" rotation="-90 0 0" position="0 1 0"></a-entity>

        <!-- Projectile attaché -->
        <a-entity id="attachedProjectile" gltf-model="#projectile" position="0 0 0" scale="0.05 0.05 0.05"></a-entity>
    </a-entity>

    <!-- Sol -->
    <a-plane rotation="-90 0 0" width="30" height="30" color="#7BC8A4" shadow="receive: true" position="0 0 0" static-body></a-plane>

    <!-- Ciel -->
    <a-sky color="#c4f6ff"></a-sky>
</a-scene>
</body>

<!-- Script-->
<script>
    // Déplacement joystick gauche
    AFRAME.registerComponent('joystick-movement', {
        schema: { speed: { type: 'number', default: 2 } },
        init: function () {
            const rig = document.querySelector('#rig');
            const head = document.querySelector('#head');
            const leftHand = document.querySelector('#leftHand');
            const speed = this.data.speed;
            const DEADZONE = 0.1;

            leftHand.addEventListener('thumbstickmoved', function (evt) {
                const dx = evt.detail.x, dy = evt.detail.y;
                if (Math.abs(dx) < DEADZONE && Math.abs(dy) < DEADZONE) return;

                const forward = new THREE.Vector3();
                head.object3D.getWorldDirection(forward);
                forward.y = 0; forward.normalize();

                const right = new THREE.Vector3();
                right.crossVectors(forward, new THREE.Vector3(0, 1, 0)).negate();

                const step = 0.05 * speed;
                const rigPos = rig.object3D.position;
                rigPos.addScaledVector(forward, dy * step);
                rigPos.addScaledVector(right,  dx * step);
            });
        }
    });

    // Rotation par crans (joystick droit)
    AFRAME.registerComponent('snap-turn', {
        schema: { angle: { type: 'number', default: 30 }, cooldown: { type: 'number', default: 300 } },
        init: function () {
            const rig = document.querySelector('#rig');
            const rightHand = document.querySelector('#rightHand');
            const angle = this.data.angle, cooldown = this.data.cooldown;
            let lastTurn = 0;
            rightHand.addEventListener('thumbstickmoved', function (evt) {
                const now = Date.now(), x = evt.detail.x;
                if (Math.abs(x) < 0.8 || now - lastTurn < cooldown) return;
                const rad = THREE.MathUtils.degToRad(angle);
                if (x > 0.8)  rig.object3D.rotation.y -= rad;
                else          rig.object3D.rotation.y += rad;
                lastTurn = now;
            });
        }
    });

    // Gun Shooting
    AFRAME.registerComponent('gun-shoot', {
        schema: {
            hand: { type: 'selector' },
            bulletSpeed: { type: 'number', default: 40 },
            cooldown: { type: 'number', default: 3000 } // 3 secondes
        },
        init: function () {
            const el = this.el;
            const hand = this.data.hand;
            const speed = this.data.bulletSpeed;
            const cooldown = this.data.cooldown;

            const shootPos = el.querySelector('#shootPos');
            const attachedProjectile = el.querySelector('#attachedProjectile');
            let cooldownActive = false;

            hand.addEventListener('triggerdown', () => {
                if (!el.is('grabbed')) return; // Tir seulement si le gun est en main
                if (cooldownActive) return;    // Empêche le spam de tir

                cooldownActive = true;

                // Cacher le projectile attaché
                attachedProjectile.setAttribute('visible', 'false');

                // Entité physique = sphère invisible
                const bullet = document.createElement('a-sphere');
                const startPos = shootPos.object3D.getWorldPosition(new THREE.Vector3());
                bullet.setAttribute('position', startPos);
                bullet.setAttribute('radius', 0.05);
                bullet.setAttribute('material', 'opacity:0; transparent:true');
                bullet.setAttribute('dynamic-body', 'mass:0.1; shape:sphere');

                // Enfant visuel = modèle 3D
                const visual = document.createElement('a-entity');
                visual.setAttribute('gltf-model', '#projectile');
                visual.setAttribute('scale', '0.05 0.05 0.05');
                visual.setAttribute('shadow', 'cast:true; receive:true');
                bullet.appendChild(visual);

                // Ajouter la balle à la scène
                el.sceneEl.appendChild(bullet);

                // Calculer la direction vers l'avant de shootPos
                const direction = new THREE.Vector3();
                shootPos.object3D.getWorldDirection(direction);
                direction.normalize();

                // Appliquer la vitesse initiale
                bullet.addEventListener('body-loaded', () => {
                    bullet.setAttribute('velocity', `${direction.x * speed} ${direction.y * speed} ${direction.z * speed}`);

                    // Forcer l'orientation visuelle dans la direction du tir
                    const lookAt = new THREE.Vector3().copy(direction).add(startPos);
                    visual.object3D.lookAt(lookAt);
                    visual.object3D.rotateX(THREE.MathUtils.degToRad(90));
                });

                // Supprimer la balle après 5 secondes
                setTimeout(() => { bullet.remove(); }, 5000);

                // Réactiver le projectile attaché + reset cooldown après 3s
                setTimeout(() => {
                    attachedProjectile.setAttribute('visible', 'true');
                    cooldownActive = false;
                }, cooldown);
            });
        }
    });
</script>
</html>
