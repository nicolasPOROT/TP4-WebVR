<!doctype html>
<html lang="fr">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>TP4 - WebVR (Ammo.js + Hand Tracking)</title>
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>

    <!-- Extras (mouvement etc.) -->
    <script src="https://cdn.jsdelivr.net/gh/c-frame/aframe-extras@7.5.0/dist/aframe-extras.min.js"></script>

    <!-- Physics system (version 5, basÃ© sur Ammo.js) -->
    <script src="https://cdn.jsdelivr.net/gh/n5ro/aframe-physics-system@5.0.0/dist/aframe-physics-system.min.js"></script>

    <style>body { margin: 0; }</style>
</head>
<body>
<a-scene physics="driver: ammo; gravity: -9.8" shadow="type: pcfsoft" background="color: #88ccee">

    <!-- Lights -->
    <a-entity id="sun" light="type: directional; intensity: 1; castShadow: true"
              position="-2 4 4" rotation="-45 30 0"></a-entity>
    <a-entity light="type: ambient; intensity: 0.5"></a-entity>

    <!-- Ground -->
    <a-plane rotation="-90 0 0" width="30" height="30"
             color="#7BC8A4" shadow="receive: true"
             static-body></a-plane>

    <!-- Interactable objects -->
    <a-box position="-1 1 -3" rotation="0 45 0"
           depth="1" height="1" width="1" color="#4CC3D9"
           shadow="cast: true; receive: true"
           dynamic-body grabbable></a-box>

    <a-sphere position="1 2 -2" radius="0.7" color="#EF2D5E"
              shadow="cast: true; receive: true"
              dynamic-body grabbable></a-sphere>

    <a-cylinder position="3 1.5 -4" radius="0.5" height="1.4" color="#FFC65D"
                shadow="cast: true; receive: true"
                dynamic-body grabbable></a-cylinder>

    <!-- Player rig -->
    <a-entity id="rig" movement-controls="speed: 0.15; fly: false">
        <!-- Camera -->
        <a-entity id="camera" camera look-controls="pointerLockEnabled: true"
                  position="0 1.6 0"></a-entity>

        <!-- Hands with hand-tracking grab controls -->
        <a-entity hand-tracking-grab-controls="hand: left"></a-entity>
        <a-entity hand-tracking-grab-controls="hand: right"></a-entity>
    </a-entity>

    <a-sky color="#c4f6ff"></a-sky>

    <!-- Rotation with right joystick -->
    <script>
        AFRAME.registerComponent('gamepad-rotate', {
            tick: function () {
                const gamepads = navigator.getGamepads ? navigator.getGamepads() : [];
                let gp = null;
                for (let i = 0; i < gamepads.length; i++) {
                    const g = gamepads[i];
                    if (g && g.connected && g.axes && g.axes.length >= 4) { gp = g; break; }
                }
                if (!gp) return;
                const rx = gp.axes[2] || 0;
                const dead = 0.2;
                const strength = Math.abs(rx) > dead ? rx : 0;
                if (strength !== 0) {
                    const rig = document.querySelector('#rig');
                    const turnSpeed = 1.8;
                    const currentRot = rig.getAttribute('rotation');
                    const newY = currentRot.y - strength * turnSpeed;
                    rig.setAttribute('rotation', { x: currentRot.x, y: newY, z: currentRot.z });
                }
            }
        });
        document.addEventListener('DOMContentLoaded', function () {
            const scene = document.querySelector('a-scene');
            if (scene) scene.setAttribute('gamepad-rotate', '');
        });
    </script>

</a-scene>
</body>
</html>
