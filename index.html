<!doctype html>
<html lang="fr">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>TP4 - WebVR</title>

    <!-- A-Frame 1.7.0 -->
    <script src="https://aframe.io/releases/1.7.0/aframe.min.js"></script>

    <!-- Supprimer grabbable existant -->
    <script>delete AFRAME.components["grabbable"];</script>

    <!-- aframe-extras (sphere-collider) -->
    <script src="https://cdn.jsdelivr.net/gh/c-frame/aframe-extras@7.5.2/dist/aframe-extras.min.js"></script>

    <!-- Physics system (CANNON) -->
    <script src="https://cdn.jsdelivr.net/npm/@c-frame/aframe-physics-system@4.1.0/dist/aframe-physics-system.min.js"></script>

    <!-- super-hands -->
    <script src="https://unpkg.com/super-hands@3.0.5/dist/super-hands.min.js"></script>

    <style>body { margin:0 }</style>
</head>
<body>
<a-scene shadow="type: pcfsoft" renderer="antialias: true" physics="gravity: -9.8; debug: false" background="color: #88ccee">

    <!-- Lights -->
    <a-entity id="sun" light="type: directional; intensity: 5; castShadow: true" position="-2 4 4" rotation="-45 30 0"></a-entity>
    <a-entity light="type: ambient; intensity: 0.8"></a-entity>

    <!-- Ground plane -->
    <a-plane rotation="-90 0 0" width="30" height="30" color="#7BC8A4" shadow="receive: true" position="0 0 0" static-body></a-plane>

    <!-- Objects with physics and grabbable -->
    <a-box class="grabbable" position="-1 1 -3" rotation="0 45 0" depth="1" height="1" width="1" color="#4CC3D9"
           shadow="cast: true; receive: true"
           grabbable="usePhysics: only" dynamic-body="mass:1; shape:box"></a-box>

    <a-sphere class="grabbable" position="1 2 -2" radius="0.7" color="#EF2D5E"
              shadow="cast: true; receive: true"
              grabbable="usePhysics: only" dynamic-body="mass:0.5; shape:sphere"></a-sphere>

    <a-cylinder class="grabbable" position="3 1.5 -4" radius="0.5" height="1.4" color="#FFC65D"
                shadow="cast: true; receive: true"
                grabbable="usePhysics: only" dynamic-body="mass:0.75; shape:cylinder"></a-cylinder>

    <!-- Camera rig + controllers -->
    <a-entity id="rig" position="0 1 0" joystick-movement="speed:2" snap-turn="angle:30; cooldown:300">
        <a-entity id="camera" camera look-controls position="0 1.6 0"></a-entity>

        <!-- Left hand → Snap-turn (changer la vue) -->
        <a-entity id="leftHand"
                  oculus-touch-controls="hand: left"
                  sphere-collider="objects: .grabbable"
                  super-hands="grabStartButtons: gripdown, squeezestart; grabEndButtons: gripup, squeezeend"
                  static-body="shape: sphere; sphereRadius:0.03">
        </a-entity>

        <!-- Right hand → Déplacement -->
        <a-entity id="rightHand"
                  oculus-touch-controls="hand: right"
                  sphere-collider="objects: .grabbable"
                  super-hands="grabStartButtons: gripdown, squeezestart; grabEndButtons: gripup, squeezeend"
                  static-body="shape: sphere; sphereRadius:0.03">
        </a-entity>
    </a-entity>

    <a-sky color="#c4f6ff"></a-sky>

    <!-- Déplacement joystick droit -->
    <script>
        AFRAME.registerComponent('joystick-movement', {
            schema: { speed: { type: 'number', default: 2 } },
            init: function () {
                const rig = this.el;
                const head = rig.querySelector('#camera');
                const rightHand = rig.querySelector('#rightHand'); // Changement ici
                const DEADZONE = 0.1;
                const speed = this.data.speed;

                rightHand.addEventListener('thumbstickmoved', evt => {
                    const dx = evt.detail.x, dy = evt.detail.y;
                    if(Math.abs(dx)<DEADZONE && Math.abs(dy)<DEADZONE) return;

                    const forward = new THREE.Vector3();
                    head.object3D.getWorldDirection(forward);
                    forward.y=0; forward.normalize();

                    const right = new THREE.Vector3();
                    right.crossVectors(forward, new THREE.Vector3(0,1,0)).negate();

                    const rigPos = rig.object3D.position;
                    rigPos.addScaledVector(forward, dy*0.05*speed);
                    rigPos.addScaledVector(right, dx*0.05*speed);
                });
            }
        });

        // Snap-turn joystick gauche
        AFRAME.registerComponent('snap-turn', {
            schema: { angle:{type:'number', default:30}, cooldown:{type:'number', default:300} },
            init: function () {
                const rig = this.el;
                const leftHand = rig.querySelector('#leftHand'); // Changement ici
                let lastTurn = 0;
                const angleRad = THREE.MathUtils.degToRad(this.data.angle);

                leftHand.addEventListener('thumbstickmoved', evt => {
                    const now = Date.now(), x=evt.detail.x;
                    if(Math.abs(x)<0.8 || now-lastTurn<this.data.cooldown) return;
                    if(x>0.8) rig.object3D.rotation.y -= angleRad;
                    else rig.object3D.rotation.y += angleRad;
                    lastTurn = now;
                });
            }
        });
    </script>
</a-scene>
</body>
</html>
